import os
import glob
import re
import sys
import io

# UTF-8 ì¸ì½”ë”© ì„¤ì •
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

# ê° í˜ì´ì§€ë³„ ì •í™•í•œ í‚¤ì›Œë“œë§Œ ë§¤í•‘ (ë§¤ìš° ì—„ê²©í•˜ê²Œ)
PAGE_SPECIFIC_KEYWORDS = {
    # ì—­ë¥˜ì„± ì‹ë„ì—¼ - ì—­ë¥˜/ì‹ë„ì—¼ ê´€ë ¨ë§Œ
    'ì—­ë¥˜ì„±ì‹ë„ì—¼': ['ì—­ë¥˜ì„±ì‹ë„ì—¼', 'ì—­ë¥˜ì„± ì‹ë„ì—¼', 'ì—­ë¥˜', 'ì‹ë„ì—¼'],
    'ì—­ë¥˜ì„± ì‹ë„ì—¼': ['ì—­ë¥˜ì„±ì‹ë„ì—¼', 'ì—­ë¥˜ì„± ì‹ë„ì—¼', 'ì—­ë¥˜', 'ì‹ë„ì—¼'],
    
    # ìœ„ì—¼ - ìœ„ì—¼/ìœ„ê¶¤ì–‘ ê´€ë ¨ë§Œ
    'ìœ„ì—¼': ['ìœ„ì—¼', 'ìœ„ê¶¤ì–‘', 'ìœ„ì—¼ìœ„ê¶¤ì–‘'],
    'ìœ„ì—¼ìœ„ê¶¤ì–‘': ['ìœ„ì—¼', 'ìœ„ê¶¤ì–‘', 'ìœ„ì—¼ìœ„ê¶¤ì–‘'],
    'ìœ„ê¶¤ì–‘': ['ìœ„ì—¼', 'ìœ„ê¶¤ì–‘', 'ìœ„ì—¼ìœ„ê¶¤ì–‘'],
    
    # ê³¼ë¯¼ì„±ëŒ€ì¥ì¦í›„êµ° - ëŒ€ì¥ ê´€ë ¨ë§Œ
    'ê³¼ë¯¼ì„±ëŒ€ì¥ì¦í›„êµ°': ['ê³¼ë¯¼ì„±ëŒ€ì¥ì¦í›„êµ°', 'ëŒ€ì¥'],
    
    # ì§€ë°©ê°„ - ê°„ ê´€ë ¨ë§Œ
    'ì§€ë°©ê°„': ['ì§€ë°©ê°„', 'ê°„ê¸°ëŠ¥'],
    'ê°„ê¸°ëŠ¥': ['ì§€ë°©ê°„', 'ê°„ê¸°ëŠ¥'],
    
    # ê³ í˜ˆì•• - ê³ í˜ˆì•• ê´€ë ¨ë§Œ
    'ê³ í˜ˆì••': ['ê³ í˜ˆì••'],
    
    # ê³ ì§€í˜ˆì¦ - ê³ ì§€í˜ˆì¦/ì½œë ˆìŠ¤í…Œë¡¤ ê´€ë ¨ë§Œ
    'ê³ ì§€í˜ˆì¦': ['ê³ ì§€í˜ˆì¦', 'ì½œë ˆìŠ¤í…Œë¡¤'],
    'ì½œë ˆìŠ¤í…Œë¡¤': ['ê³ ì§€í˜ˆì¦', 'ì½œë ˆìŠ¤í…Œë¡¤'],
    
    # ë‹¹ë‡¨ - ë‹¹ë‡¨ ê´€ë ¨ë§Œ
    'ë‹¹ë‡¨': ['ë‹¹ë‡¨', 'ë‹¹ë‡¨ë³‘', 'ê³µë³µí˜ˆë‹¹', 'ê³µë³µí˜ˆë‹¹ì¥ì• ', 'ë‹¹ë‡¨í•©ë³‘ì¦', 'ì¸ìŠë¦°', 'í˜ˆë‹¹'],
    'ë‹¹ë‡¨ë³‘': ['ë‹¹ë‡¨', 'ë‹¹ë‡¨ë³‘', 'ê³µë³µí˜ˆë‹¹', 'ê³µë³µí˜ˆë‹¹ì¥ì• ', 'ë‹¹ë‡¨í•©ë³‘ì¦'],
    'ê³µë³µí˜ˆë‹¹': ['ê³µë³µí˜ˆë‹¹', 'ê³µë³µí˜ˆë‹¹ì¥ì• '],
    'ê³µë³µí˜ˆë‹¹ì¥ì• ': ['ê³µë³µí˜ˆë‹¹', 'ê³µë³µí˜ˆë‹¹ì¥ì• '],
    'ë‹¹ë‡¨í•©ë³‘ì¦': ['ë‹¹ë‡¨í•©ë³‘ì¦'],
    'ì¸ìŠë¦°': ['ì¸ìŠë¦°'],
    'í˜ˆë‹¹': ['í˜ˆë‹¹'],
    
    # ê´€ì ˆ ê´€ë ¨
    'ê´€ì ˆì—¼': ['ê´€ì ˆì—¼', 'í‡´í–‰ì„±ê´€ì ˆì—¼'],
    'í‡´í–‰ì„±ê´€ì ˆì—¼': ['í‡´í–‰ì„±ê´€ì ˆì—¼', 'ê´€ì ˆì—¼'],
    'ì˜¤ì‹­ê²¬': ['ì˜¤ì‹­ê²¬', 'ìœ ì°©ì„±ê´€ì ˆë‚­ì—¼'],
    'í—ˆë¦¬ë””ìŠ¤í¬': ['í—ˆë¦¬ë””ìŠ¤í¬', 'ëª©ë””ìŠ¤í¬'],
    'ëª©ë””ìŠ¤í¬': ['í—ˆë¦¬ë””ìŠ¤í¬', 'ëª©ë””ìŠ¤í¬'],
    'ê³¨ë‹¤ê³µì¦': ['ê³¨ë‹¤ê³µì¦'],
    
    # í˜¸ë¥´ëª¬/ë‚´ë¶„ë¹„
    'ê°‘ìƒì„ ': ['ê°‘ìƒì„ '],
    'ê°±ë…„ê¸°': ['ê°±ë…„ê¸°', 'ê°±ë…„ê¸°ì¦í›„êµ°'],
    'ê°±ë…„ê¸°ì¦í›„êµ°': ['ê°±ë…„ê¸°', 'ê°±ë…„ê¸°ì¦í›„êµ°'],
    'ëŒ€ì‚¬ì¦í›„êµ°': ['ëŒ€ì‚¬ì¦í›„êµ°'],
    
    # ì •ì‹  ê±´ê°•/ì‹ ê²½ê³„
    'ìš°ìš¸ì¦': ['ìš°ìš¸ì¦', 'ë²ˆì•„ì›ƒ', 'ìš°ìš¸ì¦ë²ˆì•„ì›ƒ'],
    'ìš°ìš¸ì¦ë²ˆì•„ì›ƒ': ['ìš°ìš¸ì¦', 'ë²ˆì•„ì›ƒ', 'ìš°ìš¸ì¦ë²ˆì•„ì›ƒ'],
    'ìˆ˜ë©´ì¥ì• ': ['ìˆ˜ë©´ì¥ì• ', 'ë¶ˆë©´ì¦', 'ìˆ˜ë©´ì¥ì• ë¶ˆë©´ì¦'],
    'ìˆ˜ë©´ì¥ì• ë¶ˆë©´ì¦': ['ìˆ˜ë©´ì¥ì• ', 'ë¶ˆë©´ì¦', 'ìˆ˜ë©´ì¥ì• ë¶ˆë©´ì¦'],
    'ì¹˜ë§¤': ['ì¹˜ë§¤', 'ê²½ë„ì¸ì§€ì¥ì• ', 'ì¹˜ë§¤ê²½ë„ì¸ì§€ì¥ì• '],
    'ì¹˜ë§¤ê²½ë„ì¸ì§€ì¥ì• ': ['ì¹˜ë§¤', 'ê²½ë„ì¸ì§€ì¥ì• ', 'ì¹˜ë§¤ê²½ë„ì¸ì§€ì¥ì• '],
    'ì´ëª…': ['ì´ëª…', 'ì–´ì§€ëŸ¼ì¦', 'ì´ëª…ì–´ì§€ëŸ¼ì¦', 'ì´ëª…í˜„í›ˆ', 'í˜„í›ˆ'],
    'ì´ëª…ì–´ì§€ëŸ¼ì¦': ['ì´ëª…', 'ì–´ì§€ëŸ¼ì¦', 'ì´ëª…ì–´ì§€ëŸ¼ì¦'],
    'ì´ëª…í˜„í›ˆ': ['ì´ëª…', 'í˜„í›ˆ', 'ì´ëª…í˜„í›ˆ'],
    'ì–´ì§€ëŸ¼ì¦': ['ì–´ì§€ëŸ¼ì¦', 'ì´ëª…'],
    
    # ì•ˆê³¼/ì¹˜ê³¼/ê¸°íƒ€
    'ë°±ë‚´ì¥': ['ë°±ë‚´ì¥', 'ë…¹ë‚´ì¥', 'ë°±ë‚´ì¥ë…¹ë‚´ì¥'],
    'ë…¹ë‚´ì¥': ['ë°±ë‚´ì¥', 'ë…¹ë‚´ì¥', 'ë°±ë‚´ì¥ë…¹ë‚´ì¥'],
    'ë°±ë‚´ì¥ë…¹ë‚´ì¥': ['ë°±ë‚´ì¥', 'ë…¹ë‚´ì¥', 'ë°±ë‚´ì¥ë…¹ë‚´ì¥'],
    'ì¹˜ì£¼ì—¼': ['ì¹˜ì£¼ì—¼', 'ì¹˜ì•„ì†ì‹¤', 'ì¹˜ì£¼ì—¼ì¹˜ì•„ì†ì‹¤', 'ì¹˜ì£¼ì§ˆí™˜'],
    'ì¹˜ì£¼ì§ˆí™˜': ['ì¹˜ì£¼ì—¼', 'ì¹˜ì£¼ì§ˆí™˜'],
    'ë¹„ë§Œ': ['ë¹„ë§Œ', 'ì²´í˜•ë³€í™”', 'ë¹„ë§Œì²´í˜•ë³€í™”'],
    'ë¹„ë§Œì²´í˜•ë³€í™”': ['ë¹„ë§Œ', 'ì²´í˜•ë³€í™”', 'ë¹„ë§Œì²´í˜•ë³€í™”'],
    
    # ì‹¬í˜ˆê´€
    'ì‹¬ê·¼ê²½ìƒ‰': ['ì‹¬ê·¼ê²½ìƒ‰', 'í˜‘ì‹¬ì¦'],
    'í˜‘ì‹¬ì¦': ['í˜‘ì‹¬ì¦', 'ì‹¬ê·¼ê²½ìƒ‰'],
    'ë‡Œì¡¸ì¤‘': ['ë‡Œì¡¸ì¤‘'],
    'ë™ë§¥ê²½í™”': ['ë™ë§¥ê²½í™”'],
}

# í‚¤ì›Œë“œ â†’ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
KEYWORD_TO_CATEGORY = {
    # ì†Œí™”ê¸°
    'ì—­ë¥˜ì„±ì‹ë„ì—¼': 'digestive', 'ì—­ë¥˜ì„± ì‹ë„ì—¼': 'digestive', 'ì—­ë¥˜': 'digestive', 'ì‹ë„ì—¼': 'digestive',
    'ìœ„ì—¼': 'digestive', 'ìœ„ê¶¤ì–‘': 'digestive', 'ìœ„ì—¼ìœ„ê¶¤ì–‘': 'digestive',
    'ê³¼ë¯¼ì„±ëŒ€ì¥ì¦í›„êµ°': 'digestive', 'ëŒ€ì¥': 'digestive',
    'ì§€ë°©ê°„': 'digestive', 'ê°„ê¸°ëŠ¥': 'digestive',
    
    # ì‹¬í˜ˆê´€
    'ê³ í˜ˆì••': 'cardiovascular',
    'ê³ ì§€í˜ˆì¦': 'cardiovascular', 'ì½œë ˆìŠ¤í…Œë¡¤': 'cardiovascular',
    'ì‹¬ê·¼ê²½ìƒ‰': 'cardiovascular', 'í˜‘ì‹¬ì¦': 'cardiovascular',
    'ë‡Œì¡¸ì¤‘': 'cardiovascular', 'ë™ë§¥ê²½í™”': 'cardiovascular',
    
    # ë‹¹ë‡¨
    'ë‹¹ë‡¨': 'diabetes', 'ë‹¹ë‡¨ë³‘': 'diabetes',
    'ê³µë³µí˜ˆë‹¹': 'diabetes', 'ê³µë³µí˜ˆë‹¹ì¥ì• ': 'diabetes',
    'ë‹¹ë‡¨í•©ë³‘ì¦': 'diabetes', 'ì¸ìŠë¦°': 'diabetes', 'í˜ˆë‹¹': 'diabetes',
    
    # ê´€ì ˆ
    'ê´€ì ˆì—¼': 'musculoskeletal', 'í‡´í–‰ì„±ê´€ì ˆì—¼': 'musculoskeletal',
    'ì˜¤ì‹­ê²¬': 'musculoskeletal', 'ìœ ì°©ì„±ê´€ì ˆë‚­ì—¼': 'musculoskeletal',
    'í—ˆë¦¬ë””ìŠ¤í¬': 'musculoskeletal', 'ëª©ë””ìŠ¤í¬': 'musculoskeletal',
    'ê³¨ë‹¤ê³µì¦': 'musculoskeletal',
    
    # í˜¸ë¥´ëª¬
    'ê°‘ìƒì„ ': 'endocrine', 'ê°±ë…„ê¸°': 'endocrine', 'ê°±ë…„ê¸°ì¦í›„êµ°': 'endocrine',
    'ëŒ€ì‚¬ì¦í›„êµ°': 'endocrine',
    
    # ì‹ ê²½ê³„
    'ìš°ìš¸ì¦': 'neuroscience', 'ë²ˆì•„ì›ƒ': 'neuroscience', 'ìš°ìš¸ì¦ë²ˆì•„ì›ƒ': 'neuroscience',
    'ìˆ˜ë©´ì¥ì• ': 'neuroscience', 'ë¶ˆë©´ì¦': 'neuroscience', 'ìˆ˜ë©´ì¥ì• ë¶ˆë©´ì¦': 'neuroscience',
    'ì¹˜ë§¤': 'neuroscience', 'ê²½ë„ì¸ì§€ì¥ì• ': 'neuroscience', 'ì¹˜ë§¤ê²½ë„ì¸ì§€ì¥ì• ': 'neuroscience',
    'ì´ëª…': 'neuroscience', 'ì–´ì§€ëŸ¼ì¦': 'neuroscience', 'ì´ëª…ì–´ì§€ëŸ¼ì¦': 'neuroscience',
    'ì´ëª…í˜„í›ˆ': 'neuroscience', 'í˜„í›ˆ': 'neuroscience',
    
    # ì•ˆê³¼/ì¹˜ê³¼
    'ë°±ë‚´ì¥': 'eyes-dental', 'ë…¹ë‚´ì¥': 'eyes-dental', 'ë°±ë‚´ì¥ë…¹ë‚´ì¥': 'eyes-dental',
    'ì¹˜ì£¼ì—¼': 'eyes-dental', 'ì¹˜ì•„ì†ì‹¤': 'eyes-dental', 'ì¹˜ì£¼ì—¼ì¹˜ì•„ì†ì‹¤': 'eyes-dental',
    'ì¹˜ì£¼ì§ˆí™˜': 'eyes-dental',
    'ë¹„ë§Œ': 'eyes-dental', 'ì²´í˜•ë³€í™”': 'eyes-dental', 'ë¹„ë§Œì²´í˜•ë³€í™”': 'eyes-dental',
}

def get_keywords_for_page(page_title):
    """í˜ì´ì§€ ì œëª©ì— ë”°ë¼ ì •í™•í•œ í‚¤ì›Œë“œë§Œ ë°˜í™˜"""
    page_lower = page_title.lower().replace(' ', '').replace('-', '').replace('/', '').replace('(', '').replace(')', '')
    
    # ì •í™•í•œ ë§¤ì¹­ ì°¾ê¸°
    for key, keywords in PAGE_SPECIFIC_KEYWORDS.items():
        key_lower = key.lower().replace(' ', '').replace('-', '').replace('/', '').replace('(', '').replace(')', '')
        if key_lower in page_lower or page_lower in key_lower:
            return keywords
    
    # ë¶€ë¶„ ë§¤ì¹­
    for key, keywords in PAGE_SPECIFIC_KEYWORDS.items():
        key_lower = key.lower().replace(' ', '').replace('-', '').replace('/', '').replace('(', '').replace(')', '')
        if any(kw.lower().replace(' ', '') in page_lower for kw in keywords):
            return keywords
    
    return []

def fix_file(filepath):
    """íŒŒì¼ì˜ í‚¤ì›Œë“œ ë§µì„ í˜ì´ì§€ë³„ë¡œ ì •í™•í•˜ê²Œ ìˆ˜ì •"""
    print(f"Processing: {filepath}")
    
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # í˜ì´ì§€ ì œëª© ì¶”ì¶œ
        page_title_match = re.search(r'<h1 class="page-title">(.*?)</h1>', content)
        if not page_title_match:
            page_title_match = re.search(r'<title>(.*?)(?:\s*-\s*9988.*?)?</title>', content)
        
        page_title = page_title_match.group(1).strip() if page_title_match else ''
        print(f"  í˜ì´ì§€ ì œëª©: {page_title}")
        
        # í•´ë‹¹ í˜ì´ì§€ì— ë§ëŠ” ì •í™•í•œ í‚¤ì›Œë“œë§Œ ì¶”ì¶œ
        page_keywords = get_keywords_for_page(page_title)
        
        if not page_keywords:
            print(f"  âš ï¸  í‚¤ì›Œë“œë¥¼ ì°¾ì§€ ëª»í•¨, ìŠ¤í‚µ")
            return False
        
        print(f"  âœ… ë§¤í•‘í•  í‚¤ì›Œë“œ: {page_keywords}")
        
        # í‚¤ì›Œë“œ ë§µ ìƒì„± (í•´ë‹¹ í˜ì´ì§€ì˜ í‚¤ì›Œë“œë§Œ í¬í•¨)
        keyword_map_js = "const keywordMap = {\n"
        for keyword in page_keywords:
            if keyword in KEYWORD_TO_CATEGORY:
                category = KEYWORD_TO_CATEGORY[keyword]
                keyword_map_js += f"                    '{keyword}': ['{category}'],\n"
        keyword_map_js += "                };"
        
        # ê¸°ì¡´ í‚¤ì›Œë“œ ë§µ êµì²´
        old_keyword_map = r"const keywordMap = \{[\s\S]*?\};"
        if re.search(old_keyword_map, content):
            content = re.sub(old_keyword_map, keyword_map_js, content, flags=re.DOTALL)
            print(f"  âœ… í‚¤ì›Œë“œ ë§µ ì—…ë°ì´íŠ¸ (ì •í™•í•œ í‚¤ì›Œë“œë§Œ)")
        
        # íŒŒì¼ ì €ì¥
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        
        return True
        
    except Exception as e:
        print(f"  âŒ ì˜¤ë¥˜: {e}")
        import traceback
        traceback.print_exc()
        return False

def main():
    print("=" * 60)
    print("ğŸ”’ í˜ì´ì§€ë³„ ì •í™•í•œ í‚¤ì›Œë“œë§Œ ë§¤í•‘ (ë§¤ìš° ì—„ê²©)")
    print("=" * 60)
    
    # news-main.html ì œì™¸ (ê±´ê°•NewsëŠ” ëª¨ë“  ê¸€ í‘œì‹œ)
    target_files = glob.glob("sub-*.html")
    
    print(f"\nğŸ“ ì´ {len(target_files)}ê°œ íŒŒì¼")
    
    success_count = 0
    for file in target_files:
        if fix_file(file):
            success_count += 1
    
    print("\n" + "=" * 60)
    print(f"âœ… ì™„ë£Œ: {success_count}/{len(target_files)}ê°œ íŒŒì¼")
    print("=" * 60)
    print("\nğŸ“ ê°œì„ ì‚¬í•­:")
    print("  âœ… ê° í˜ì´ì§€ë³„ ì •í™•í•œ í‚¤ì›Œë“œë§Œ ë§¤í•‘")
    print("  âœ… ì—­ë¥˜ì„± ì‹ë„ì—¼: ì—­ë¥˜/ì‹ë„ì—¼ ê´€ë ¨ë§Œ")
    print("  âœ… ê³¼ë¯¼ì„±ëŒ€ì¥ì¦í›„êµ°, ì§€ë°©ê°„ ë“± ì œì™¸")
    print("  âœ… ê´€ë ¨ ì—†ëŠ” ê¸€ ì™„ì „ ì°¨ë‹¨")

if __name__ == "__main__":
    main()

